---
title: "HR Analytics Standard Report"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dpi = 300
)

library(dplyr)
library(ggplot2)
library(reactable)
library(ggthemes)
library(data.table)
library(stringr)

# set default color palette with scale_color_brewer
theme_set(
  theme_few()
)
```

# Overview

This report provides a standard set of indicators and visualizations on HRMIS analytics, building on the World Bank's [Public Sector and Employment Assessment Framework](https://documents1.worldbank.org/curated/en/324801640074379484/pdf/Public-Sector-Employment-and-Compensation-An-Assessment-Framework.pdf). The objective of this assessment is to conduct public sector employment and compensation assessments that can help develop evidence-based reforms.

The assessment framework consists of two parts. The first part assesses both the institutional and behavioral aspects of employment and compensation practices. It comprises six dimensions:

1. Wage bill planning.
2. Wage bill controls.
3. Employment levels and distribution of the public sector workforce.
4. Wage competitiveness of the public sector.
5. Wage equity.
6. Wage incentives.

The second part assesses the impact of these employment and compensation practices on:

1. Fiscal sustainability.
2. Public sector productivity.
3. Labor allocation between the public and private sectors.

## Preparing the data

We have designed a convenient function, `govhr::compute_hrmreport_stats`, that produces all summary statistics necessary to produce the standard report on HR. All you need to do is provide the three standard modules as inputs to the function.

```{r}
library(govhr)

hrm_report_stats <- compute_hrmreport_stats(
  contract_dt = govhr::bra_hrmis_contract,
  worker_dt = govhr::bra_hrmis_worker,
  org_dt = govhr::bra_hrmis_org,
  macro_indicators = govhr::macro_indicators
)
```

## 4.1. Fiscal sustainability {.tabset-dropdown}

The wage bill can potentially have a major effect on fiscal balances, but there are no simple benchmarks for the “right” size of the wage bill. In fact, cross-national evidence suggests that there is no strong correlation between the size of the wage bill and fiscal balance. Wage bill dynamics are a better predictor of fiscal sustainability. In general, increases in the wage bill are associated with worsening of the fiscal balance. In addition, wage expenditures are pro-cyclical, rising during periods of economic growth, but not falling as much during downturns due to structural rigidity.

Guidance questions for the assessment:

1. What are the wage bill dynamics and how are changes in the wage bill being financed - i.e. through deficits, raising revenues, or reducing other expenditures?
2. What are the main drivers of wage bill growth?
3. What are the wage bill projections for baseline and different policy option scenarios based on wage bill modeling?

### 4.1.1. Correlation between wage bill growth and fiscal balances

```{r}
wagebill_annual <- hrm_report_stats |>
  pluck(
    "wagebill"
  ) |> 
  pluck(
    "wagebill_annual"
  ) |> 
  filter(
    indicator == "gross_salary_ppp_sum"
  ) |> 
  mutate(
    country_code = "BRA"
  ) |> 
  left_join(
    macro_indicators, by = c("country_code", "year")
  )

wagebill_annual |> 
  compute_change(
    value,
    date_col = year
  ) |>
  ggplot() +
  geom_point(
    aes(fiscal_balance, value_growth)
  ) +
  scale_y_continuous(
    labels = scales::percent_format()
  ) +
  labs(
    x = "Fiscal balance",
    y = "Wage bill (annual growth)"
  )
```

### Decomposition of wage growth: employment and wages

```{r}
annual_headcount <- hrm_report_stats |> 
  pluck("publicemployment_share") |> 
  select(
    year,
    headcount = summary_value
  )
  
wagebill_annual |>
  left_join(
    annual_headcount,
    by = "year"
  ) |> 
  filter(year <= 2017) |>
  transmute(
    year,
    `Median Wage (PPP)` = value/value[year == min(year)] * 100,
    `Total Headcount` = headcount/headcount[year == min(year)] * 100
  ) |>
  pivot_longer(
    -c(year),
    names_to = "Indicator"
  ) |>
  ggplot_point_line(
    year,
    value,
    group = Indicator
  ) +
  labs(
    x = "Year",
    y = "Indicator"
  )
```

## 6. Wage incentives {.tabset-dropdown}

The extent to which wage increases are explicitly linked to performance is important for both employee motivation and public sector productivity. This section provide some key stylized facts that provide evidence of the productivity and fiscal implications of pay incentives. These include: the magnitude of promotion-based and seniority-based annual wage increases, expected wage increases over an employee's career and the coverage and key design features of performance bonuses.

Guidance questions for the assessment:

1. What wage growth is typical for public sector employees in different occupational groups over the course of their career? How of much of this wage growth is dependent on promotions and how much can occur “within grade”?
2. Does the annual performance management system distinguish between high and low performers? Are promotion decisions largely seniority based and/or automatic?
3. Are there performance bonus schemes and if so what occupation groups and percentage of the staff receive them; and how large is the bonus that staff are expected to receive?
4. Is there targeted, significant additional pay for essential workers to serve in hard-to-staff locations such as rural areas?

### 6.1. Allowances as a share of gross pay

```{r}
hrm_report_stats |> 
  pluck("wagebill_allowshare_paygrade") |> 
  filter(
    paygrade %in% 1:4
  ) |> 
  ggplot_point_line(
    year,
    allowance_rate,
    group = paygrade
  ) +
  labs(
    x = "Year",
    y = "Allowance as Share of Gross Salary",
    title = "Allowance as Share of Gross Salary, by Paygrade"
  )
```
### 6.2. Percentage of staff receiving a performance bonus

```{r}
# 3.6.3. percentage of staff receiving a performance bonus
performance_bonus_worker <- govhr::bra_hrmis_contract |>
  filter(
    !is.na(allowance_lcu)
  ) |>
  group_by(year) |>
  summarise(
    total_performance = n_distinct(worker_id)
  )

govhr::bra_hrmis_contract |>
  group_by(year) |>
  summarise(
    total = n_distinct(worker_id)
  ) |>
  left_join(
    performance_bonus_worker,
    by = "year"
  ) |>
  mutate(
    year = as.numeric(year),
    share_performance = total_performance/total
  ) |>
  ggplot_point_line(
    year,
    share_performance
  ) +
  scale_y_continuous(
    labels = scales::percent_format()
  ) +
  labs(
    x = "Year",
    y = "Share of personnel"
  )
```

